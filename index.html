<script type="module">
        // Importando do link direto (CDN)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, update, onValue, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // --- IMPORTANDO SUAS PERGUNTAS E RESPOSTAS DO NOVO ARQUIVO ---
        import { questoesIntro, questoesComp } from './banco_questoes.js';

        // Disponibiliza as variáveis importadas para o resto do código
        window.questoesIntro = questoesIntro;
        window.questoesComp = questoesComp;

        // SUA CONFIGURAÇÃO DO FIREBASE
        const firebaseConfig = {
          apiKey: "AIzaSyCHfcVVxma4M1LbYO5M-oMX4fnlaNUPi24",
          authDomain: "fracoesbanco.firebaseapp.com",
          databaseURL: "https://fracoesbanco-default-rtdb.firebaseio.com",
          projectId: "fracoesbanco",
          storageBucket: "fracoesbanco.firebasestorage.app",
          messagingSenderId: "873014790580",
          appId: "1:873014790580:web:09b340386d10d7f88a4ae1"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        let alunoId = localStorage.getItem('firebaseId');
        const SENHA_ALUNO = "1234";

        // As funções f, iconCadeado, etc, continuam aqui para uso na interface
        const iconCadeadoAberto = `<svg viewBox="0 0 24 24"><path d="M12 17c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm6-9h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6h2c0-1.66 1.34-3 3-3s3 1.34 3 3v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2z"/></svg>`;
        const iconCadeadoFechado = `<svg viewBox="0 0 24 24"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2-2zM9 8V6c0-1.66 1.34-3 3-3s3 1.34 3 3v2H9z"/></svg>`;

        window.modoAtual = localStorage.getItem('modoAtual') || 'intro'; 
        window.indice = parseInt(localStorage.getItem('indice')) || 0;
        window.placarIntro = JSON.parse(localStorage.getItem('placarIntro')) || { acertos: 0, erros: 0 };
        window.placarComp = JSON.parse(localStorage.getItem('placarComp')) || { acertos: 0, erros: 0 };

        window.realizarLogin = function() {
            const inputNome = document.getElementById('inputNomeAluno');
            const inputSenha = document.getElementById('inputSenhaAcesso');
            const aviso = document.getElementById('erroNome');
            let nome = inputNome.value.trim();
            let senha = inputSenha.value.trim();
            if (!nome) { aviso.innerText = "Por favor, digite seu nome."; return; }
            if (nome.includes(" ")) { aviso.innerText = "Digite apenas o primeiro nome."; return; }
            if (nome.length > 15) { aviso.innerText = "O nome deve ter no máximo 15 letras."; return; }
            if (senha !== SENHA_ALUNO) { aviso.innerText = "Senha da turma incorreta."; return; }

            nome = nome.charAt(0).toUpperCase() + nome.slice(1).toLowerCase();
            const ano = document.querySelector('input[name="ano"]:checked');
            const turma = document.querySelector('input[name="serie"]:checked');
            if (!ano || !turma) { aviso.innerText = "Selecione Ano e Turma."; return; }

            const serieCompleta = `${ano.value} ${turma.value}`;
            localStorage.setItem('alunoNome', nome);
            localStorage.setItem('alunoSerie', serieCompleta);
            window.aplicarDadosUsuario(nome, serieCompleta);

            if (!alunoId) {
                const novoAlunoRef = push(ref(db, 'alunos'));
                alunoId = novoAlunoRef.key;
                localStorage.setItem('firebaseId', alunoId);
            }
            update(ref(db, 'alunos/' + alunoId), {
                nome: nome,
                serie: serieCompleta,
                acertos: 0,
                erros: 0,
                entrouEm: new Date().toISOString(),
                status: 'online'
            });

            document.getElementById('modalLogin').classList.remove('visivel');
            mostrarApp();
        };

        window.checkLogin = function() {
            const nomeSalvo = localStorage.getItem('alunoNome');
            const serieSalva = localStorage.getItem('alunoSerie');
            if (nomeSalvo && serieSalva) {
                window.aplicarDadosUsuario(nomeSalvo, serieSalva);
                if(alunoId) { update(ref(db, 'alunos/' + alunoId), { status: 'reconectado', ultimoAcesso: new Date().toISOString() }); }
                document.getElementById('modalLogin').classList.remove('visivel');
                mostrarApp();
            } else {
                document.getElementById('modalLogin').classList.add('visivel');
            }
        };

        window.responder = function(i, btn) {
            const listaQuestao = window.modoAtual === 'intro' ? questoesIntro : questoesComp;
            const q = listaQuestao[window.indice];
            const todos = document.querySelectorAll('.btn-opcao');
            todos.forEach(b => b.disabled = true);
            
            document.getElementById('btnProximo').style.display = 'block';
            document.getElementById('areaResposta').style.display = 'block';
            const titulo = document.getElementById('tituloFeedback');
            let placarAtual = window.modoAtual === 'intro' ? window.placarIntro : window.placarComp;

            if (i === q.correta) {
                placarAtual.acertos++;
                btn.classList.add('certo');
                titulo.innerText = "Resposta Correta!";
                titulo.style.color = "var(--success)";
            } else {
                placarAtual.erros++;
                btn.classList.add('errado');
                todos[q.correta].classList.add('certo'); 
                titulo.innerText = "Resposta Incorreta";
                titulo.style.color = "var(--error)";
            }
            
            document.getElementById('textoResolucao').innerHTML = q.resolucao;
            window.salvarProgresso();
            window.atualizarPlacarVisual();
            window.atualizarBarraProgresso();

            if (alunoId && window.modoAtual === 'complementar') {
                update(ref(db, 'alunos/' + alunoId), {
                    acertos: window.placarComp.acertos,
                    erros: window.placarComp.erros,
                    ultimoAcesso: new Date().toISOString()
                });
            }
        };

        // BLOQUEIO/LIBERAÇÃO REMOTA (TELA DE ESPERA)
        const statusRef = ref(db, 'status_atividade');
        onValue(statusRef, (snapshot) => {
            const dados = snapshot.val();
            // Se o comando for 'finalizar', mostra a tela. Se for 'liberado', esconde.
            if (dados && dados.comando === 'finalizar') {
                document.getElementById('telaBloqueio').classList.add('visivel');
            } else {
                document.getElementById('telaBloqueio').classList.remove('visivel');
            }
        });

        // Funções Auxiliares
        window.aplicarDadosUsuario = function(nome, serie) {
            document.getElementById('badgeNome').innerText = nome;
            document.getElementById('badgeSerie').innerText = serie;
            document.getElementById('nomeAlunoFase').innerText = nome;
            document.getElementById('nomeAlunoFinal').innerText = nome;
        }
        window.mostrarApp = function() { document.getElementById('appContainer').style.opacity = '1'; }
        window.salvarProgresso = function() {
            localStorage.setItem('modoAtual', window.modoAtual);
            localStorage.setItem('indice', window.indice);
            localStorage.setItem('placarIntro', JSON.stringify(window.placarIntro));
            localStorage.setItem('placarComp', JSON.stringify(window.placarComp));
        }
        window.abrirModalReset = function() { document.getElementById('modalReset').classList.add('visivel'); document.getElementById('inputSenha').value = ''; }
        window.fecharModalReset = function() { document.getElementById('modalReset').classList.remove('visivel'); }
        window.confirmarReset = function() {
            if (document.getElementById('inputSenha').value === "4241") { localStorage.clear(); location.reload(); } else { alert("Senha incorreta."); }
        }
        window.abrirModalHistorico = function() {
            document.getElementById('histIntroAcertos').innerText = window.placarIntro.acertos;
            document.getElementById('histIntroErros').innerText = window.placarIntro.erros;
            document.getElementById('histCompAcertos').innerText = window.placarComp.acertos;
            document.getElementById('histCompErros').innerText = window.placarComp.erros;
            document.getElementById('modalHistorico').classList.add('visivel');
        }
        window.fecharModalHistorico = function() { document.getElementById('modalHistorico').classList.remove('visivel'); }
        window.abrirModalFase = function() {
            const nome = localStorage.getItem('alunoNome') || 'Aluno';
            document.getElementById('nomeAlunoFase').innerText = nome;
            document.getElementById('modalFase').classList.add('visivel');
        }
        window.abrirModalFinal = function() {
            const nome = localStorage.getItem('alunoNome') || 'Aluno';
            document.getElementById('nomeAlunoFinal').innerText = nome;
            document.getElementById('finalAcertos').innerText = window.placarComp.acertos;
            document.getElementById('finalErros').innerText = window.placarComp.erros;
            document.getElementById('modalFinal').classList.add('visivel');
        }
        window.avancarFase = function() {
            window.modoAtual = 'complementar'; window.indice = 0; 
            window.salvarProgresso(); document.getElementById('modalFase').classList.remove('visivel'); window.carregar(); 
        }
        window.atualizarBotoesHeader = function() {
            const btnIntro = document.getElementById('btnIntro');
            const btnComp = document.getElementById('btnComplementar');
            btnIntro.className = 'top-item'; btnComp.className = 'top-item';
            if (window.modoAtual === 'intro') {
                btnIntro.classList.add('bg-verde-ativo'); btnIntro.innerHTML = `${iconCadeadoAberto} Introdução`;
                btnComp.classList.add('bg-cinza-claro', 'hover-red'); btnComp.innerHTML = `${iconCadeadoFechado} Atividade complementar`;
            } else {
                btnIntro.classList.add('bg-cinza-claro', 'hover-red'); btnIntro.innerHTML = `${iconCadeadoFechado} Introdução`; 
                btnComp.classList.add('bg-verde-ativo'); btnComp.innerHTML = `${iconCadeadoAberto} Atividade complementar`; 
            }
        }
        window.atualizarPlacarVisual = function() {
            if (window.modoAtual === 'intro') {
                document.getElementById('scoreC').innerText = window.placarIntro.acertos;
                document.getElementById('scoreE').innerText = window.placarIntro.erros;
            } else {
                document.getElementById('scoreC').innerText = window.placarComp.acertos;
                document.getElementById('scoreE').innerText = window.placarComp.erros;
            }
        }
        window.atualizarBarraProgresso = function() {
            const listaAtual = window.modoAtual === 'intro' ? questoesIntro : questoesComp;
            const placarAtual = window.modoAtual === 'intro' ? window.placarIntro : window.placarComp;
            const respondidas = placarAtual.acertos + placarAtual.erros;
            const porcentagem = (respondidas / listaAtual.length) * 100;
            const largura = porcentagem > 100 ? 100 : porcentagem;
            document.getElementById('barraFill').style.width = largura + '%';
        }
        window.carregar = function() {
            window.checkLogin(); window.atualizarBotoesHeader(); window.atualizarPlacarVisual();
            const listaQuestao = window.modoAtual === 'intro' ? questoesIntro : questoesComp;
            if (window.indice >= listaQuestao.length) {
                if (window.modoAtual === 'intro') { window.abrirModalFase(); } else { document.getElementById('barraFill').style.width = '100%'; window.abrirModalFinal(); }
                return;
            }
            window.atualizarBarraProgresso();
            const q = listaQuestao[window.indice];
            document.getElementById('areaResposta').style.display = 'none';
            document.getElementById('btnProximo').style.display = 'none';
            document.getElementById('imgQuestao').src = q.img;
            document.getElementById('textoPergunta').innerHTML = q.pergunta;
            const divBotoes = document.getElementById('containerOpcoes');
            divBotoes.innerHTML = '';
            q.opcoes.forEach((opt, i) => {
                const btn = document.createElement('button');
                btn.className = 'btn-opcao'; btn.innerHTML = opt; btn.onclick = () => window.responder(i, btn);
                divBotoes.appendChild(btn);
            });
        }
        window.proximaQuestao = function() {
            window.indice++; window.salvarProgresso(); window.carregar();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        window.onload = window.carregar;

    </script>
