<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel do Professor - Ranking</title>
    <style>
        :root {
            --bg-page: #f5f5f7;
            --card-bg: #ffffff;
            --text-main: #1d1d1f;
            --text-light: #86868b;
            --accent: #0071e3;
            --success: #34c759;
            --warning: #ffcc00;
            --silver: #e0e0e0;
            --bronze: #cd7f32;
            --error: #ff3b30;
            --radius: 16px;
            --shadow: 0 4px 20px rgba(0,0,0,0.05);
            --btn-gray-dark: #8e8e93;  
        }

        /* --- PROTE√á√ÉO ANTI-C√ìPIA --- */
        body {
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
        }
        @media print { html, body { display: none !important; } }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }

        body {
            background-color: var(--bg-page);
            color: var(--text-main);
            min-height: 100vh;
            padding: 40px 20px;
            padding-bottom: 100px;
            overflow-x: hidden;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
        }

        /* --- HEADER --- */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .titulo-pagina { font-size: 2rem; font-weight: 700; }

        .btn-voltar {
            text-decoration: none; color: var(--accent); font-weight: 600;
            display: flex; align-items: center; gap: 5px; transition: opacity 0.2s; font-size: 0.9rem; margin-bottom: 5px;
        }
        .btn-voltar:hover { opacity: 0.7; }

        .filtro-data-container {
            background: white; padding: 10px 20px; border-radius: 50px;
            box-shadow: var(--shadow); display: flex; align-items: center; gap: 10px;
        }
        .input-data { border: none; background: transparent; font-size: 1rem; color: var(--accent); font-weight: 600; cursor: pointer; outline: none; }

        /* --- FILTROS E A√á√ïES --- */
        .area-filtros-topo {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            gap: 15px;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }

        .dropdown-wrapper { position: relative; display: inline-block; }

        .btn-filtro-trigger {
            background-color: white; color: var(--text-main); padding: 12px 25px; border-radius: 50px; border: none; font-size: 1rem; font-weight: 600; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.08); display: flex; align-items: center; gap: 10px; transition: all 0.3s ease; min-width: 160px; justify-content: space-between;
        }
        .btn-filtro-trigger:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,0,0,0.12); }
        .btn-filtro-trigger.ativo { border: 2px solid var(--accent); color: var(--accent); }

        .btn-finalizar { background-color: white; color: var(--error); border: 1px solid rgba(255, 59, 48, 0.3); }
        .btn-finalizar:hover { background-color: var(--error); color: white; border-color: var(--error); box-shadow: 0 6px 15px rgba(255, 59, 48, 0.25); }

        .seta-dropdown { width: 14px; height: 14px; fill: var(--text-light); transition: transform 0.3s; }
        .dropdown-wrapper.aberto .seta-dropdown { transform: rotate(180deg); fill: var(--accent); }

        .dropdown-menu {
            position: absolute; top: 120%; left: 0; width: 100%; min-width: 200px; background-color: white; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); padding: 10px; z-index: 100; opacity: 0; visibility: hidden; transform: translateY(-10px); transition: all 0.2s cubic-bezier(0.165, 0.84, 0.44, 1);
        }
        .dropdown-wrapper.aberto .dropdown-menu { opacity: 1; visibility: visible; transform: translateY(0); }

        .opcao-item {
            display: block; width: 100%; text-align: left; padding: 10px 15px; background: none; border: none; border-radius: 8px; font-size: 0.95rem; color: var(--text-main); cursor: pointer; font-weight: 500; transition: background 0.2s;
        }
        .opcao-item:hover { background-color: #f2f2f7; color: var(--accent); }
        .opcao-item.selecionado { background-color: var(--accent); color: white; }

        /* --- CARDS E TABELA --- */
        .grid-resumo {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px; margin-bottom: 30px;
        }
        .card-resumo {
            background: var(--card-bg); padding: 20px; border-radius: var(--radius);
            box-shadow: var(--shadow); display: flex; flex-direction: column; align-items: flex-start;
        }
        .card-titulo { font-size: 0.85rem; color: var(--text-light); text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; margin-bottom: 5px; }
        .card-valor { font-size: 2rem; font-weight: 700; color: var(--text-main); }
        
        .painel-ranking {
            background: var(--card-bg); border-radius: var(--radius);
            box-shadow: var(--shadow); overflow: hidden; min-height: 300px;
        }

        .tabela-header {
            display: grid; 
            grid-template-columns: 0.5fr 2fr 1.5fr 0.8fr 0.8fr 1fr; 
            padding: 15px 20px;
            background-color: rgba(0,0,0,0.02); border-bottom: 1px solid #e5e5ea;
            font-size: 0.8rem; font-weight: 600; color: var(--text-light); text-transform: uppercase;
        }

        .lista-alunos { list-style: none; }
        .item-aluno {
            display: grid; 
            grid-template-columns: 0.5fr 2fr 1.5fr 0.8fr 0.8fr 1fr; 
            padding: 15px 20px; align-items: center; border-bottom: 1px solid #f5f5f7;
            transition: background 0.2s;
        }
        .item-aluno:last-child { border-bottom: none; }
        .item-aluno:hover { background-color: #fafafa; }

        .posicao { font-weight: 700; color: var(--text-light); font-size: 1.1rem; }
        .rank-1 .posicao { color: transparent; text-shadow: 0 0 0 var(--warning); font-size: 1.5rem; }
        .rank-2 .posicao { color: transparent; text-shadow: 0 0 0 var(--silver); font-size: 1.5rem; }
        .rank-3 .posicao { color: transparent; text-shadow: 0 0 0 var(--bronze); font-size: 1.5rem; }

        .info-nome { font-weight: 600; font-size: 1.05rem; }
        .info-serie { display: inline-block; padding: 4px 12px; border-radius: 20px; background-color: #f2f2f7; color: var(--text-light); font-size: 0.8rem; font-weight: 600; }
        .info-nota { font-weight: 700; color: var(--success); }
        .info-erro { font-weight: 700; color: var(--error); }
        .info-tempo { font-size: 0.9rem; color: var(--text-light); text-align: right; }

        /* --- NOTIFICA√á√ïES --- */
        .notificacao-container {
            position: fixed; top: 20px; right: 20px; z-index: 2000;
            display: flex; flex-direction: column; gap: 10px; pointer-events: none;
        }
        .toast {
            background-color: var(--success); color: white; padding: 12px 20px; border-radius: 50px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.15); font-size: 0.9rem; font-weight: 600;
            display: flex; align-items: center; gap: 10px;
            animation: slideIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            opacity: 1; transition: opacity 0.5s, transform 0.5s; max-width: 300px;
        }
        .toast.saindo { opacity: 0; transform: translateY(-20px); }
        .toast.alerta { background-color: var(--error); }
        
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* --- RODAP√â --- */
        .rodape-gestao {
            margin-top: 50px; text-align: center; border-top: 1px solid #e5e5ea; padding-top: 30px;
            display: flex; flex-direction: column; align-items: center; gap: 15px;
        }
        .btn-acao-rodape {
            background-color: var(--btn-gray-dark); color: white; border: none; padding: 12px 30px; 
            border-radius: 50px; font-size: 0.9rem; font-weight: 600; cursor: pointer;
            transition: transform 0.2s, background-color 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .btn-acao-rodape:hover { background-color: var(--error); transform: scale(1.02); }
        .texto-creditos { font-size: 0.8rem; color: var(--text-light); }

        /* --- MODAIS --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(10px);
            display: none; justify-content: center; align-items: center; z-index: 1000; animation: fadeIn 0.3s ease;
        }
        .modal-overlay.visivel { display: flex; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-box {
            background: white; padding: 30px; border-radius: 16px; width: 90%; max-width: 400px; text-align: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2); animation: popIn 0.3s ease;
        }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-titulo { font-size: 1.3rem; font-weight: 700; margin-bottom: 10px; }
        .modal-desc { font-size: 0.95rem; color: var(--text-light); margin-bottom: 25px; line-height: 1.4; }
        
        /* ESTILO DOS BOT√ïES DE RESET (Cinza que vira Vermelho) */
        .grid-botoes-reset { display: flex; flex-direction: column; gap: 10px; }
        
        .btn-reset-opcao {
            padding: 15px;
            border-radius: 12px;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            /* Cor padr√£o Cinza */
            background-color: #e5e5ea;
            color: var(--text-main);
        }

        /* Hover Vermelho para TODOS os bot√µes de reset */
        .btn-reset-opcao:hover {
            transform: scale(1.02);
            background-color: var(--error);
            color: white;
            box-shadow: 0 4px 10px rgba(255, 59, 48, 0.3);
        }

        .btn-cancelar { margin-top: 15px; background: none; border: none; color: var(--text-light); cursor: pointer; font-size: 0.9rem; text-decoration: underline; }

        .botoes-confirmacao { display: flex; gap: 15px; justify-content: center; }
        .btn-conf-sim { background-color: var(--error); color: white; flex: 1; }
        .btn-conf-nao { background-color: #e5e5ea; color: var(--text-main); flex: 1; }

        @media (max-width: 700px) {
            .tabela-header { display: none; }
            .item-aluno {
                grid-template-columns: 40px 1fr auto auto;
                grid-template-areas: "pos nome nota erro" "pos serie tempo tempo";
                gap: 5px; padding: 15px;
            }
            .posicao { grid-area: pos; align-self: center; }
            .info-nome { grid-area: nome; }
            .info-nota { grid-area: nota; text-align: right; }
            .info-erro { grid-area: erro; text-align: right; margin-left: 10px; }
            .info-serie { grid-area: serie; align-self: start; }
            .info-tempo { grid-area: tempo; text-align: right; font-size: 0.8rem; }
            
            .area-filtros-topo { gap: 10px; justify-content: center; }
            .btn-filtro-trigger, .btn-finalizar { width: 100%; min-width: auto; }
        }
    </style>
</head>
<body>
    <script>
        // Seguran√ßa
        document.addEventListener('contextmenu', event => event.preventDefault());
        document.onkeydown = function(e) {
            if (e.keyCode == 123) return false;
            if (e.ctrlKey && (e.key === 'u' || e.key === 's' || e.key === 'p')) return false;
            if (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'J' || e.key === 'C')) return false;
        };
        document.ondragstart = function() { return false; };
    </script>

    <div id="containerNotificacoes" class="notificacao-container"></div>

    <div class="container">
        <header>
            <div class="titulo-container">
                <a href="index.html" class="btn-voltar">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
                    Voltar para Atividade
                </a>
                <h1 class="titulo-pagina">Painel da Turma</h1>
            </div>
            
            <div class="filtro-data-container">
                <span style="font-size:0.8rem; color:var(--text-light); font-weight:600;">Data:</span>
                <input type="date" id="filtroData" class="input-data">
            </div>
        </header>

        <div class="area-filtros-topo">
            <div class="dropdown-wrapper" id="dropAno">
                <button class="btn-filtro-trigger" onclick="toggleDropdown('dropAno')">
                    <span id="textoAno">Ano: Todos</span>
                    <svg class="seta-dropdown" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
                </button>
                <div class="dropdown-menu">
                    <button class="opcao-item selecionado" onclick="selecionarOpcao('ano', 'todas', 'Todos', this)">Todos</button>
                    <button class="opcao-item" onclick="selecionarOpcao('ano', '6¬∫ Ano', '6¬∫ Ano', this)">6¬∫ Ano</button>
                    <button class="opcao-item" onclick="selecionarOpcao('ano', '7¬∫ Ano', '7¬∫ Ano', this)">7¬∫ Ano</button>
                    <button class="opcao-item" onclick="selecionarOpcao('ano', '8¬∫ Ano', '8¬∫ Ano', this)">8¬∫ Ano</button>
                    <button class="opcao-item" onclick="selecionarOpcao('ano', '9¬∫ Ano', '9¬∫ Ano', this)">9¬∫ Ano</button>
                </div>
            </div>

            <div class="dropdown-wrapper" id="dropTurma">
                <button class="btn-filtro-trigger" onclick="toggleDropdown('dropTurma')">
                    <span id="textoTurma">Turma: Todas</span>
                    <svg class="seta-dropdown" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
                </button>
                <div class="dropdown-menu">
                    <button class="opcao-item selecionado" onclick="selecionarOpcao('turma', 'todas', 'Todas', this)">Todas</button>
                    <button class="opcao-item" onclick="selecionarOpcao('turma', 'A', 'Turma A', this)">Turma A</button>
                    <button class="opcao-item" onclick="selecionarOpcao('turma', 'B', 'Turma B', this)">Turma B</button>
                    <button class="opcao-item" onclick="selecionarOpcao('turma', 'C', 'Turma C', this)">Turma C</button>
                </div>
            </div>

            <button class="btn-filtro-trigger btn-finalizar" onclick="abrirModalFinalizar()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="9" y1="9" x2="15" y2="15"></line><line x1="15" y1="9" x2="9" y2="15"></line></svg>
                Finalizar Atividade
            </button>
        </div>

        <div class="grid-resumo">
            <div class="card-resumo">
                <span class="card-titulo">Total de Alunos</span>
                <span class="card-valor" id="totalAcessos">0</span>
            </div>
            <div class="card-resumo">
                <span class="card-titulo">M√©dia da Turma</span>
                <span class="card-valor" id="mediaAcertos" style="color: var(--accent)">0.0</span>
            </div>
            <div class="card-resumo">
                <span class="card-titulo">Melhor Desempenho</span>
                <span class="card-valor" id="melhorAluno">-</span>
            </div>
        </div>

        <div class="painel-ranking">
            <div class="tabela-header">
                <div>#</div>
                <div>Aluno</div>
                <div>S√©rie</div>
                <div>Acertos</div>
                <div>Erros</div>
                <div style="text-align: right;">Hor√°rio</div>
            </div>
            <ul id="listaRanking" class="lista-alunos">
                <li style="padding:40px; text-align:center; color:var(--text-light)">Carregando dados...</li>
            </ul>
        </div>

        <div class="rodape-gestao">
            <button class="btn-acao-rodape" onclick="abrirModalReset()">
                Gerenciar Hist√≥rico
            </button>
            <div style="display:flex; flex-direction:column; gap:5px;">
                <span class="texto-creditos">√Årea restrita ao professor</span>
                <span class="texto-creditos" style="font-weight:600; color:var(--text-main)">Desenvolvido por Gilberto Fernandes - Matem√°tica</span>
            </div>
        </div>
    </div>

    <div id="modalReset" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-titulo">Limpar Dados</div>
            <div class="modal-desc">Selecione uma op√ß√£o e insira a senha.</div>
            
            <div class="grid-botoes-reset">
                <button class="btn-reset-opcao" onclick="resetar('hoje')">Limpar registros de <b>Hoje</b></button>
                <button class="btn-reset-opcao" onclick="resetar('mes')">Limpar registros do <b>M√™s</b></button>
                <button class="btn-reset-opcao" onclick="resetar('tudo')">üóëÔ∏è Resetar <b>Site Inteiro</b></button>
            </div>
            <button class="btn-cancelar" onclick="fecharModalReset()">Cancelar</button>
        </div>
    </div>

    <div id="modalFinalizar" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-titulo" style="color:var(--error)">Finalizar Atividade?</div>
            <div class="modal-desc">
                Voc√™ tem certeza que deseja encerrar a atividade para todos os alunos agora?<br>
                <small>Eles receber√£o uma notifica√ß√£o imediata.</small>
            </div>
            
            <div class="botoes-confirmacao">
                <button class="btn-reset-opcao btn-conf-nao" onclick="fecharModalFinalizar()">N√£o</button>
                <button class="btn-reset-opcao btn-conf-sim" onclick="confirmarFinalizar()">Sim, Finalizar</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, set, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // SUA CONFIGURA√á√ÉO
        const firebaseConfig = {
          apiKey: "AIzaSyCHfcVVxma4M1LbYO5M-oMX4fnlaNUPi24",
          authDomain: "fracoesbanco.firebaseapp.com",
          databaseURL: "https://fracoesbanco-default-rtdb.firebaseio.com",
          projectId: "fracoesbanco",
          storageBucket: "fracoesbanco.firebasestorage.app",
          messagingSenderId: "873014790580",
          appId: "1:873014790580:web:09b340386d10d7f88a4ae1"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        let todosRegistros = [];
        let filtroAnoAtual = "todas";
        let filtroTurmaAtual = "todas";

        const alunosRef = ref(db, 'alunos');
        
        onValue(alunosRef, (snapshot) => {
            const dados = snapshot.val();
            todosRegistros = [];
            
            if (dados) {
                Object.keys(dados).forEach(key => {
                    const aluno = dados[key];
                    let horaFormatada = "--:--";
                    if(aluno.entrouEm) {
                        const d = new Date(aluno.entrouEm);
                        horaFormatada = d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    }
                    todosRegistros.push({
                        id: key,
                        nome: aluno.nome,
                        serie: aluno.serie,
                        acertos: aluno.acertos || 0,
                        erros: aluno.erros || 0,
                        data: aluno.entrouEm ? aluno.entrouEm.split('T')[0] : '',
                        hora: horaFormatada,
                        timestamp: new Date(aluno.entrouEm).getTime(),
                        notificado: false
                    });
                });
                
                const agora = new Date().getTime();
                const ultimosNotificados = JSON.parse(sessionStorage.getItem('notificados')) || [];
                todosRegistros.forEach(a => {
                    if (agora - a.timestamp < 20000 && !ultimosNotificados.includes(a.id)) {
                        window.mostrarNotificacao(a.nome + " entrou na atividade");
                        ultimosNotificados.push(a.id);
                    }
                });
                sessionStorage.setItem('notificados', JSON.stringify(ultimosNotificados));
            }
            window.renderizarRanking();
        });

        window.mostrarNotificacao = function(texto, tipo = 'sucesso') {
            const container = document.getElementById('containerNotificacoes');
            const toast = document.createElement('div');
            toast.className = 'toast';
            if(tipo === 'alerta') toast.classList.add('alerta');
            const icon = tipo === 'alerta' 
                ? `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>`
                : `<svg width="20" height="20" viewBox="0 0 24 24" fill="white"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>`;
            toast.innerHTML = `${icon} ${texto}`;
            container.appendChild(toast);
            setTimeout(() => { toast.classList.add('saindo'); setTimeout(() => toast.remove(), 500); }, 3000);
        };

        window.abrirModalFinalizar = () => document.getElementById('modalFinalizar').classList.add('visivel');
        window.fecharModalFinalizar = () => document.getElementById('modalFinalizar').classList.remove('visivel');
        
        // --- FINALIZAR COM PROMPT ---
        window.confirmarFinalizar = function() {
            // Primeiro fecha o modal
            window.fecharModalFinalizar();
            
            // Depois pede a senha
            setTimeout(() => {
                const senha = prompt("Digite a senha do professor para confirmar:");
                if (senha !== '4241') {
                    alert('Senha incorreta!');
                    return;
                }
                
                set(ref(db, 'status_atividade'), { comando: 'finalizar', data: new Date().toISOString() });
                window.mostrarNotificacao("Atividade encerrada para todos!", 'alerta');
            }, 100);
        };

        // --- RESET COM PROMPT ---
        window.abrirModalReset = () => document.getElementById('modalReset').classList.add('visivel');
        window.fecharModalReset = () => document.getElementById('modalReset').classList.remove('visivel');

        window.resetar = function(tipo) {
            // Pede a senha AP√ìS clicar no bot√£o
            const senha = prompt("Digite a senha do professor para confirmar a exclus√£o:");
            
            if (senha !== '4241') {
                alert('Senha incorreta!');
                return;
            }

            if (!confirm("Confirmar exclus√£o definitiva?")) return;
            
            if (tipo === 'tudo') {
                remove(ref(db, 'alunos'));
                set(ref(db, 'status_atividade'), { comando: 'liberado' });
                alert("Banco de dados limpo e reiniciado!");
            } else if (tipo === 'hoje') {
                const hoje = new Date().toISOString().split('T')[0];
                todosRegistros.forEach(aluno => {
                    if (aluno.data === hoje) remove(ref(db, 'alunos/' + aluno.id));
                });
                alert("Registros de hoje apagados.");
            } else {
                alert("Para limpar o m√™s, use o 'Resetar Site Inteiro' ou apague manualmente no console do Firebase.");
            }
            window.fecharModalReset();
        };

        window.toggleDropdown = function(id) {
            const el = document.getElementById(id); const estaAberto = el.classList.contains('aberto');
            document.querySelectorAll('.dropdown-wrapper').forEach(d => d.classList.remove('aberto'));
            if(!estaAberto) el.classList.add('aberto');
        }
        document.addEventListener('click', function(e) { if (!e.target.closest('.dropdown-wrapper')) document.querySelectorAll('.dropdown-wrapper').forEach(d => d.classList.remove('aberto')); });
        window.selecionarOpcao = function(tipo, valor, textoExibicao, elemento) {
            const wrapperId = tipo === 'ano' ? 'dropAno' : 'dropTurma';
            const wrapper = document.getElementById(wrapperId);
            wrapper.querySelectorAll('.opcao-item').forEach(i => i.classList.remove('selecionado'));
            elemento.classList.add('selecionado');
            if(tipo === 'ano') { filtroAnoAtual = valor; document.getElementById('textoAno').innerText = 'Ano: ' + textoExibicao; } else { filtroTurmaAtual = valor; document.getElementById('textoTurma').innerText = 'Turma: ' + textoExibicao; }
            wrapper.classList.remove('aberto');
            window.renderizarRanking();
        }

        const listaEl = document.getElementById('listaRanking');
        const filtroData = document.getElementById('filtroData');
        filtroData.valueAsDate = new Date();
        filtroData.addEventListener('change', () => window.renderizarRanking());

        window.renderizarRanking = function() {
            const dataSel = filtroData.value;
            let filtrados = todosRegistros.filter(item => {
                const bateData = item.data === dataSel;
                const bateAno = filtroAnoAtual === 'todas' ? true : item.serie.includes(filtroAnoAtual);
                const bateTurma = filtroTurmaAtual === 'todas' ? true : item.serie.endsWith(" " + filtroTurmaAtual);
                return bateData && bateAno && bateTurma;
            });
            filtrados.sort((a, b) => b.acertos - a.acertos);
            document.getElementById('totalAcessos').innerText = filtrados.length;
            let totalAcertos = filtrados.reduce((sum, item) => sum + item.acertos, 0);
            let media = filtrados.length ? (totalAcertos / filtrados.length).toFixed(1) : "0.0";
            document.getElementById('mediaAcertos').innerText = media;
            document.getElementById('melhorAluno').innerText = filtrados.length > 0 ? filtrados[0].nome : "-";
            listaEl.innerHTML = "";
            if (filtrados.length === 0) { listaEl.innerHTML = `<li style="padding:40px; text-align:center; color:var(--text-light)">Aguardando dados...</li>`; return; }
            filtrados.forEach((aluno, index) => {
                let rankClass = ""; let iconePosicao = index + 1;
                if (index === 0) { rankClass = "rank-1"; iconePosicao = "ü•á"; } else if (index === 1) { rankClass = "rank-2"; iconePosicao = "ü•à"; } else if (index === 2) { rankClass = "rank-3"; iconePosicao = "ü•â"; }
                const html = `
                    <li class="item-aluno ${rankClass}">
                        <div class="posicao">${iconePosicao}</div>
                        <div class="info-nome">${aluno.nome}</div>
                        <div><span class="info-serie">${aluno.serie}</span></div>
                        <div class="info-nota">${aluno.acertos} pts</div>
                        <div class="info-erro">${aluno.erros} err</div>
                        <div class="info-tempo">${aluno.hora}</div>
                    </li>
                `;
                listaEl.innerHTML += html;
            });
        }
    </script>
</body>
</html>
