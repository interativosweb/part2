<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel do Professor - Ranking</title>
    <style>
        :root {
            --bg-page: #f5f5f7;
            --card-bg: #ffffff;
            --text-main: #1d1d1f;
            --text-light: #86868b;
            --accent: #0071e3;
            --success: #34c759;
            --warning: #ffcc00;
            --silver: #e0e0e0;
            --bronze: #cd7f32;
            --error: #ff3b30;
            --radius: 16px;
            --shadow: 0 4px 20px rgba(0,0,0,0.05);
            --btn-gray-dark: #8e8e93;
        }

        /* --- ESTILO DE FRA√á√ÉO (VERTICAL) --- */
        .fracao {
            display: inline-flex;
            flex-direction: column;
            vertical-align: middle;
            margin: 0 5px;
            text-align: center;
            font-size: 0.9em;
        }
        .fracao > span {
            padding: 0 5px;
        }
        .fracao > span:first-child {
            border-bottom: 2px solid currentColor;
            padding-bottom: 1px;
        }

        /* --- PROTE√á√ÉO ANTI-C√ìPIA --- */
        body {
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
        }
        @media print { html, body { display: block !important; } }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }

        body {
            background-color: var(--bg-page);
            color: var(--text-main);
            min-height: 100vh;
            padding: 40px 20px;
            padding-bottom: 100px;
            overflow-x: hidden;
            overflow: auto;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
        }

        /* --- HEADER --- */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 20px; }
        .titulo-pagina { font-size: 2rem; font-weight: 700; }
        .btn-voltar { text-decoration: none; color: var(--accent); font-weight: 600; display: flex; align-items: center; gap: 5px; transition: opacity 0.2s; font-size: 0.9rem; margin-bottom: 5px; }
        .btn-voltar:hover { opacity: 0.7; }
        .filtro-data-container { background: white; padding: 10px 20px; border-radius: 50px; box-shadow: var(--shadow); display: flex; align-items: center; gap: 10px; }
        .input-data { border: none; background: transparent; font-size: 1rem; color: var(--accent); font-weight: 600; cursor: pointer; outline: none; }

        /* --- FILTROS E A√á√ïES --- */
        .area-filtros-topo { display: flex; justify-content: flex-start; align-items: center; gap: 15px; margin-bottom: 40px; flex-wrap: wrap; }
        .dropdown-wrapper { position: relative; display: inline-block; }
        .btn-filtro-trigger { background-color: white; color: var(--text-main); padding: 12px 25px; border-radius: 50px; border: none; font-size: 1rem; font-weight: 600; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.08); display: flex; align-items: center; gap: 10px; transition: all 0.3s ease; min-width: 160px; justify-content: space-between; }
        .btn-filtro-trigger:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,0,0,0.12); }
        .btn-filtro-trigger.ativo { border: 2px solid var(--accent); color: var(--accent); }
        .seta-dropdown { width: 14px; height: 14px; fill: var(--text-light); transition: transform 0.3s; }
        .dropdown-wrapper.aberto .seta-dropdown { transform: rotate(180deg); fill: var(--accent); }
        .dropdown-menu { position: absolute; top: 120%; left: 0; width: 100%; min-width: 200px; background-color: white; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); padding: 10px; z-index: 100; opacity: 0; visibility: hidden; transform: translateY(-10px); transition: all 0.2s cubic-bezier(0.165, 0.84, 0.44, 1); }
        .dropdown-wrapper.aberto .dropdown-menu { opacity: 1; visibility: visible; transform: translateY(0); }
        .opcao-item { display: block; width: 100%; text-align: left; padding: 10px 15px; background: none; border: none; border-radius: 8px; font-size: 0.95rem; color: var(--text-main); cursor: pointer; font-weight: 500; transition: background 0.2s; }
        .opcao-item:hover { background-color: #f2f2f7; color: var(--accent); }
        .opcao-item.selecionado { background-color: var(--accent); color: white; }

        /* BOT√ïES DE A√á√ÉO */
        .btn-finalizar { background-color: white; color: var(--error); border: 1px solid rgba(255, 59, 48, 0.3); }
        .btn-finalizar:hover { background-color: var(--error); color: white; border-color: var(--error); box-shadow: 0 6px 15px rgba(255, 59, 48, 0.25); }
        .btn-liberar { background-color: white; color: var(--success); border: 1px solid rgba(52, 199, 89, 0.3); }
        .btn-liberar:hover { background-color: var(--success); color: white; border-color: var(--success); box-shadow: 0 6px 15px rgba(52, 199, 89, 0.25); }

        /* --- CARDS E TABELA --- */
        .grid-resumo { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card-resumo { background: var(--card-bg); padding: 20px; border-radius: var(--radius); box-shadow: var(--shadow); display: flex; flex-direction: column; align-items: flex-start; }
        .card-titulo { font-size: 0.85rem; color: var(--text-light); text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; margin-bottom: 5px; }
        .card-valor { font-size: 2rem; font-weight: 700; color: var(--text-main); }
        .painel-ranking { background: var(--card-bg); border-radius: var(--radius); box-shadow: var(--shadow); overflow: hidden; min-height: 300px; }
        .tabela-header { display: grid; grid-template-columns: 0.5fr 2fr 1.5fr 0.8fr 0.8fr 1fr; padding: 15px 20px; background-color: rgba(0,0,0,0.02); border-bottom: 1px solid #e5e5ea; font-size: 0.8rem; font-weight: 600; color: var(--text-light); text-transform: uppercase; }
        .lista-alunos { list-style: none; }
        .item-aluno { display: grid; grid-template-columns: 0.5fr 2fr 1.5fr 0.8fr 0.8fr 1fr; padding: 15px 20px; align-items: center; border-bottom: 1px solid #f5f5f7; transition: background 0.2s; }
        .item-aluno:last-child { border-bottom: none; }
        .item-aluno:hover { background-color: #fafafa; }
        .posicao { font-weight: 700; color: var(--text-light); font-size: 1.1rem; }
        .rank-1 .posicao { color: transparent; text-shadow: 0 0 0 var(--warning); font-size: 1.5rem; }
        .rank-2 .posicao { color: transparent; text-shadow: 0 0 0 var(--silver); font-size: 1.5rem; }
        .rank-3 .posicao { color: transparent; text-shadow: 0 0 0 var(--bronze); font-size: 1.5rem; }
        .info-nome { font-weight: 600; font-size: 1.05rem; }
        .info-serie { display: inline-block; padding: 4px 12px; border-radius: 20px; background-color: #f2f2f7; color: var(--text-light); font-size: 0.8rem; font-weight: 600; }
        .info-nota { font-weight: 700; color: var(--success); }
        .info-erro { font-weight: 700; color: var(--error); }
        .info-tempo { font-size: 0.9rem; color: var(--text-light); text-align: right; }

        /* --- NOTIFICA√á√ïES --- */
        .notificacao-container { position: fixed; top: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { background-color: var(--success); color: white; padding: 12px 20px; border-radius: 50px; box-shadow: 0 5px 15px rgba(0,0,0,0.15); font-size: 0.9rem; font-weight: 600; display: flex; align-items: center; gap: 10px; animation: slideIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); opacity: 1; transition: opacity 0.5s, transform 0.5s; max-width: 300px; }
        .toast.saindo { opacity: 0; transform: translateY(-20px); }
        .toast.alerta { background-color: var(--error); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* --- RODAP√â --- */
        .rodape-gestao { margin-top: 50px; text-align: center; border-top: 1px solid #e5e5ea; padding-top: 30px; display: flex; flex-direction: column; align-items: center; gap: 15px; }
        .btn-acao-rodape { background-color: var(--btn-gray-dark); color: white; border: none; padding: 12px 30px; border-radius: 50px; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: transform 0.2s, background-color 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .btn-acao-rodape:hover { background-color: var(--error); transform: scale(1.02); }
        .texto-creditos { font-size: 0.8rem; color: var(--text-light); }

        /* --- MODAIS GERAIS --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(10px); display: none; justify-content: center; align-items: center; z-index: 1000; animation: fadeIn 0.3s ease; }
        .modal-overlay.visivel { display: flex; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-box { background: white; padding: 30px; border-radius: 16px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.2); animation: popIn 0.3s ease; }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-titulo { font-size: 1.3rem; font-weight: 700; margin-bottom: 10px; }
        .modal-desc { font-size: 0.95rem; color: var(--text-light); margin-bottom: 15px; line-height: 1.4; }
        .input-senha { width: 100%; padding: 12px; border: 1px solid #d2d2d7; border-radius: 8px; font-size: 1rem; margin-bottom: 20px; outline: none; text-align: center; transition: border 0.2s; }
        .input-senha:focus { border-color: var(--accent); }
        .grid-botoes-reset { display: flex; flex-direction: column; gap: 10px; }
        .btn-reset-opcao { padding: 15px; border-radius: 12px; border: none; font-size: 1rem; font-weight: 600; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px; transition: all 0.2s; background-color: #e5e5ea; color: var(--text-main); }
        .btn-reset-opcao:hover { transform: scale(1.02); background-color: var(--error); color: white; box-shadow: 0 4px 10px rgba(255, 59, 48, 0.3); }
        .btn-cancelar { margin-top: 15px; background: none; border: none; color: var(--text-light); cursor: pointer; font-size: 0.9rem; text-decoration: underline; }
        .botoes-confirmacao { display: flex; gap: 15px; justify-content: center; }
        .btn-conf-sim { background-color: var(--error); color: white; flex: 1; }
        .btn-conf-liberar { background-color: var(--success); color: white; flex: 1; }
        .btn-conf-nao { background-color: #e5e5ea; color: var(--text-main); flex: 1; }

        @media (max-width: 700px) {
            .tabela-header { display: none; }
            .item-aluno { grid-template-columns: 40px 1fr auto auto; grid-template-areas: "pos nome nota erro" "pos serie tempo tempo"; gap: 5px; padding: 15px; }
            .posicao { grid-area: pos; align-self: center; }
            .info-nome { grid-area: nome; }
            .info-nota { grid-area: nota; text-align: right; }
            .info-erro { grid-area: erro; text-align: right; margin-left: 10px; }
            .info-serie { grid-area: serie; align-self: start; }
            .info-tempo { grid-area: tempo; text-align: right; font-size: 0.8rem; }
            .area-filtros-topo { gap: 10px; justify-content: center; }
            .btn-filtro-trigger, .btn-finalizar, .btn-liberar { width: 100%; min-width: auto; }
        }
    
        /* =======================
           ‚úÖ Modal do aluno
           ======================= */
        .aluno-modal-overlay{ position: fixed; inset: 0; background: rgba(0,0,0,.45); display:flex; align-items:center; justify-content:center; z-index: 9999; padding: 18px; }
        .aluno-modal{ width: min(520px, 96vw); background: #ffffff; border-radius: 16px; box-shadow: 0 18px 50px rgba(0,0,0,.25); padding: 16px 16px 14px 16px; position: relative; }
        .aluno-modal-header{ display:flex; align-items:flex-start; justify-content:space-between; gap: 12px; margin-bottom: 10px; }
        .aluno-modal-nome{ font-size: 1.2rem; font-weight: 800; color: #111827; line-height: 1.2; }
        .aluno-modal-sub{ font-size: .92rem; color: #6b7280; margin-top: 2px; }
        .aluno-modal-fechar{ border: none; background: #f3f4f6; color: #111827; width: 36px; height: 36px; border-radius: 10px; cursor: pointer; font-size: 18px; transition: transform .15s ease, background .15s ease; }
        .aluno-modal-fechar:hover{ transform: scale(1.06); background: #e5e7eb; }
        
        .aluno-modal-botoes{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px; }
        .btn-placar{ display:flex; align-items:center; justify-content:space-between; gap: 10px; border: none; border-radius: 14px; padding: 14px 14px; cursor: pointer; font-weight: 800; transition: transform .16s ease, box-shadow .16s ease, filter .16s ease; user-select:none; }
        .btn-placar:hover{ transform: translateY(-2px) scale(1.02); box-shadow: 0 14px 30px rgba(0,0,0,.18); filter: brightness(1.02); }
        .btn-placar:active{ transform: translateY(0) scale(.99); }
        
        /* ‚úÖ CORES ATUALIZADAS (PEDIDO DO USU√ÅRIO) */
        .btn-acerto{ background: #34c759; color: #ffffff; }
        .btn-erro{ background: #ff3b30; color: #ffffff; }

        .btn-num{ background: rgba(255,255,255,.22); padding: 6px 10px; border-radius: 999px; font-weight: 900; min-width: 46px; text-align:center; }
        .dot{ width: 10px; height: 10px; border-radius: 999px; display:inline-block; margin-right: 10px; box-shadow: 0 0 0 6px rgba(255,255,255,.18); }
        .dot-verde{ background:#065f46; }
        .dot-vermelho{ background:#7f1d1d; }
        .aluno-modal-dica{ margin-top: 12px; font-size: .92rem; color: #374151; background: #f9fafb; border: 1px solid #e5e7eb; padding: 10px 12px; border-radius: 12px; }

        /* Lista ao lado */
        .lista-modal{ width: min(520px, 96vw); background: #ffffff; border-radius: 16px; box-shadow: 0 18px 50px rgba(0,0,0,.25); padding: 14px; position: fixed; right: 18px; top: 18px; max-height: calc(100vh - 36px); overflow: hidden; }
        @media (max-width: 1100px){
          .lista-modal{ position: static; margin-top: 12px; width: min(520px, 96vw); }
          .aluno-modal-overlay{ flex-direction: column; overflow:auto; }
        }
        .lista-modal-header{ display:flex; align-items:center; justify-content:space-between; gap: 10px; margin-bottom: 10px; }
        .lista-modal-titulo{ font-size: 1.05rem; font-weight: 900; color: #111827; }
        .lista-modal-fechar{ border: none; background: #f3f4f6; color: #111827; width: 34px; height: 34px; border-radius: 10px; cursor: pointer; font-size: 16px; transition: transform .15s ease, background .15s ease; }
        .lista-modal-fechar:hover{ transform: scale(1.06); background: #e5e7eb; }
        .lista-questoes{ overflow:auto; max-height: calc(100vh - 120px); padding-right: 6px; }

        /* ITEM DA QUEST√ÉO */
        .item-questao{
          border: 1px solid #e5e7eb;
          border-radius: 14px;
          padding: 10px 12px;
          margin-bottom: 10px;
          cursor: pointer;
          transition: all 0.2s ease;
          background: #ffffff;
        }

        /* ‚úÖ HOVER VERDE + TEXTO BRANCO */
        .item-questao:hover{
          transform: translateY(-2px);
          box-shadow: 0 12px 22px rgba(0,0,0,.12);
          background-color: #34c759;
          border-color: #34c759;
          color: white;
        }
        .item-questao:hover .txt-curto { color: white; }
        .item-questao:hover .chip { background: rgba(255,255,255,0.25); color: white; }

        .item-questao .linha1{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom: 6px; }
        .chip{ font-size: .78rem; font-weight: 800; padding: 4px 10px; border-radius: 999px; background: #f3f4f6; color:#111827; flex: 0 0 auto; transition: background 0.2s, color 0.2s; }
        .txt-curto{ font-size: .92rem; color:#374151; line-height: 1.25; display:-webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow:hidden; transition: color 0.2s; }

    </style>
</head>
<body>
    <div id="containerNotificacoes" class="notificacao-container"></div>

    <div class="container">
        <header>
            <div class="titulo-container">
                <a href="index.html" class="btn-voltar">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
                    Voltar para Atividade
                </a>
                <h1 class="titulo-pagina">Painel da Turma</h1>
            </div>

            <div class="filtro-data-container">
                <span style="font-size:0.8rem; color:var(--text-light); font-weight:600;">Data:</span>
                <input type="date" id="filtroData" class="input-data">
            </div>
        </header>

        <div class="area-filtros-topo">
            <div class="dropdown-wrapper" id="dropAno">
                <button class="btn-filtro-trigger" onclick="toggleDropdown('dropAno')">
                    <span id="textoAno">Ano: Todos</span>
                    <svg class="seta-dropdown" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
                </button>
                <div class="dropdown-menu">
                    <button class="opcao-item selecionado" onclick="selecionarOpcao('ano', 'todas', 'Todos', this)">Todos</button>
                    <button class="opcao-item" onclick="selecionarOpcao('ano', '6¬∫ Ano', '6¬∫ Ano', this)">6¬∫ Ano</button>
                    <button class="opcao-item" onclick="selecionarOpcao('ano', '7¬∫ Ano', '7¬∫ Ano', this)">7¬∫ Ano</button>
                    <button class="opcao-item" onclick="selecionarOpcao('ano', '8¬∫ Ano', '8¬∫ Ano', this)">8¬∫ Ano</button>
                    <button class="opcao-item" onclick="selecionarOpcao('ano', '9¬∫ Ano', '9¬∫ Ano', this)">9¬∫ Ano</button>
                </div>
            </div>

            <div class="dropdown-wrapper" id="dropTurma">
                <button class="btn-filtro-trigger" onclick="toggleDropdown('dropTurma')">
                    <span id="textoTurma">Turma: Todas</span>
                    <svg class="seta-dropdown" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
                </button>
                <div class="dropdown-menu">
                    <button class="opcao-item selecionado" onclick="selecionarOpcao('turma', 'todas', 'Todas', this)">Todas</button>
                    <button class="opcao-item" onclick="selecionarOpcao('turma', 'A', 'Turma A', this)">Turma A</button>
                    <button class="opcao-item" onclick="selecionarOpcao('turma', 'B', 'Turma B', this)">Turma B</button>
                    <button class="opcao-item" onclick="selecionarOpcao('turma', 'C', 'Turma C', this)">Turma C</button>
                </div>
            </div>

            <button class="btn-filtro-trigger btn-liberar" onclick="abrirModalLiberar()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                Liberar Atividade
            </button>

            <button class="btn-filtro-trigger btn-finalizar" onclick="abrirModalFinalizar()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="9" y1="9" x2="15" y2="15"></line><line x1="15" y1="9" x2="9" y2="15"></line></svg>
                Finalizar Atividade
            </button>
        </div>

        <div class="grid-resumo">
            <div class="card-resumo">
                <span class="card-titulo">Total de Alunos</span>
                <span class="card-valor" id="totalAcessos">0</span>
            </div>
            <div class="card-resumo">
                <span class="card-titulo">M√©dia da Turma</span>
                <span class="card-valor" id="mediaAcertos" style="color: var(--accent)">0.0</span>
            </div>
            <div class="card-resumo">
                <span class="card-titulo">Melhor Desempenho</span>
                <span class="card-valor" id="melhorAluno">-</span>
            </div>
        </div>

        <div class="painel-ranking">
            <div class="tabela-header">
                <div>#</div>
                <div>Aluno</div>
                <div>S√©rie</div>
                <div>Acertos</div>
                <div>Erros</div>
                <div style="text-align: right;">Hor√°rio</div>
            </div>
            <ul id="listaRanking" class="lista-alunos">
                <li style="padding:40px; text-align:center; color:var(--text-light)">Carregando dados...</li>
            </ul>
        </div>

        <div class="rodape-gestao">
            <button class="btn-acao-rodape" onclick="abrirModalReset()">
                Gerenciar Hist√≥rico
            </button>
            <div style="display:flex; flex-direction:column; gap:5px;">
                <span class="texto-creditos">√Årea restrita ao professor</span>
                <span class="texto-creditos" style="font-weight:600; color:var(--text-main)">Desenvolvido por Gilberto Fernandes - Matem√°tica</span>
            </div>
        </div>
    </div>

    <div id="modalReset" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-titulo">Limpar Dados</div>
            <div class="modal-desc">Selecione o que deseja apagar (Pedir√° senha em seguida).</div>
            <div class="grid-botoes-reset">
                <button class="btn-reset-opcao" onclick="prepararReset('hoje')">Limpar registros de <b>Hoje</b></button>
                <button class="btn-reset-opcao" onclick="prepararReset('mes')">Limpar registros do <b>M√™s</b></button>
                <button class="btn-reset-opcao" onclick="prepararReset('tudo')">üóëÔ∏è Resetar <b>Site Inteiro</b></button>
            </div>
            <button class="btn-cancelar" onclick="fecharModalReset()">Cancelar</button>
        </div>
    </div>

    <div id="modalSenhaAction" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-titulo">Confirmar Exclus√£o</div>
            <div class="modal-desc" id="descSenhaAction">Digite a senha para confirmar.</div>
            <input type="password" id="inputSenhaAction" class="input-senha" placeholder="Senha do Professor">
            <button class="btn-reset-opcao" style="width:100%; background-color:var(--error); color:white" onclick="executarResetConfirmado()">Confirmar Apagar</button>
            <button class="btn-cancelar" onclick="fecharModalSenhaAction()">Cancelar</button>
        </div>
    </div>

    <div id="modalFinalizar" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-titulo" style="color:var(--error)">Finalizar Atividade?</div>
            <div class="modal-desc">Digite a senha para encerrar a atividade.<br><small>Isso bloquear√° a tela dos alunos.</small></div>
            <input type="password" id="inputSenhaFinalizar" class="input-senha" placeholder="Senha do Professor">
            <div class="botoes-confirmacao">
                <button class="btn-reset-opcao btn-conf-nao" onclick="fecharModalFinalizar()">N√£o</button>
                <button class="btn-reset-opcao btn-conf-sim" onclick="confirmarFinalizar()">Sim, Finalizar</button>
            </div>
        </div>
    </div>

    <div id="modalLiberar" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-titulo" style="color:var(--success)">Liberar Atividade?</div>
            <div class="modal-desc">Digite a senha para desbloquear a tela dos alunos.<br><small>Todos poder√£o acessar novamente.</small></div>
            <input type="password" id="inputSenhaLiberar" class="input-senha" placeholder="Senha do Professor">
            <div class="botoes-confirmacao">
                <button class="btn-reset-opcao btn-conf-nao" onclick="fecharModalLiberar()">N√£o</button>
                <button class="btn-reset-opcao btn-conf-liberar" onclick="confirmarLiberar()">Sim, Liberar</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, set, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        
        const firebaseConfig = {
          apiKey: "AIzaSyCHfcVVxma4M1LbYO5M-oMX4fnlaNUPi24",
          authDomain: "fracoesbanco.firebaseapp.com",
          databaseURL: "https://fracoesbanco-default-rtdb.firebaseio.com",
          projectId: "fracoesbanco",
          storageBucket: "fracoesbanco.firebasestorage.app",
          messagingSenderId: "873014790580",
          appId: "1:873014790580:web:09b340386d10d7f88a4ae1"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // FUN√á√ïES GLOBAIS
        function normalizarLista(v){
            if (Array.isArray(v)) return v;
            if (!v) return [];
            if (typeof v === 'string') return [v];
            if (typeof v === 'object') {
                try { return Object.values(v).filter(x=>x!==null && x!==undefined); } catch(e) { return []; }
            }
            return [];
        }

        function _escapeHTML(s){
            return String(s ?? "").replace(/[&<>"]/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;" }[c]));
        }

        let questoesIntro = [];
        let questoesComp = [];
        (async () => {
            const candidatos = ["./banco_questoes.js", "./banco_questoes (21).js", "./banco_questoes(21).js", "./banco_questoes (23).js"];
            for (const caminho of candidatos) {
                try {
                    const mod = await import(caminho);
                    questoesIntro = mod.questoesIntro || [];
                    questoesComp = mod.questoesComp || [];
                    console.log("Banco carregado:", caminho);
                    return;
                } catch (e) {}
            }
            console.warn("Banco n√£o encontrado.");
        })();

        let todosRegistros = [];
        let filtroAnoAtual = "todas";
        let filtroTurmaAtual = "todas";
        let tipoResetPendente = null;

        function getAcertosTotal(aluno){
            const aT = Number(aluno.acertosTotal);
            if (!Number.isNaN(aT) && aluno.acertosTotal !== undefined) return aT;
            const aI = Number(aluno.acertosIntro);
            const aC = Number(aluno.acertosComp);
            if (!Number.isNaN(aI) || !Number.isNaN(aC)) return (Number.isNaN(aI)?0:aI) + (Number.isNaN(aC)?0:aC);
            return Number.isNaN(Number(aluno.acertos)) ? 0 : Number(aluno.acertos);
        }

        function getErrosTotal(aluno){
            const eT = Number(aluno.errosTotal);
            if (!Number.isNaN(eT) && aluno.errosTotal !== undefined) return eT;
            const eI = Number(aluno.errosIntro);
            const eC = Number(aluno.errosComp);
            if (!Number.isNaN(eI) || !Number.isNaN(eC)) return (Number.isNaN(eI)?0:eI) + (Number.isNaN(eC)?0:eC);
            return Number.isNaN(Number(aluno.erros)) ? 0 : Number(aluno.erros);
        }

        const alunosRef = ref(db, 'alunos');
        onValue(alunosRef, (snapshot) => {
            const dados = snapshot.val();
            todosRegistros = [];
            if (dados) {
                Object.keys(dados).forEach(key => {
                    const aluno = dados[key];
                    let horaFormatada = "--:--";
                    if(aluno.entrouEm) {
                        const d = new Date(aluno.entrouEm);
                        horaFormatada = d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    }
                    todosRegistros.push({
                        id: key,
                        nome: aluno.nome,
                        serie: aluno.serie,
                        acertos: getAcertosTotal(aluno),
                        erros: getErrosTotal(aluno),
                        listaAcertos: normalizarLista(aluno.listaAcertos),
                        listaErros: normalizarLista(aluno.listaErros),
                        data: aluno.entrouEm ? aluno.entrouEm.split('T')[0] : '',
                        hora: horaFormatada,
                        timestamp: aluno.entrouEm ? new Date(aluno.entrouEm).getTime() : 0,
                    });
                });
                const agora = new Date().getTime();
                const ultimosNotificados = JSON.parse(sessionStorage.getItem('notificados')) || [];
                todosRegistros.forEach(a => {
                    if (agora - a.timestamp < 20000 && !ultimosNotificados.includes(a.id)) {
                        window.mostrarNotificacao(a.nome + " entrou na atividade");
                        ultimosNotificados.push(a.id);
                    }
                });
                sessionStorage.setItem('notificados', JSON.stringify(ultimosNotificados));
            }
            if (typeof window.renderizarRanking === 'function') window.renderizarRanking();
            else setTimeout(() => { if (typeof window.renderizarRanking === 'function') window.renderizarRanking(); }, 0);
        });

        window.mostrarNotificacao = function(texto, tipo = 'sucesso') {
            const container = document.getElementById('containerNotificacoes');
            const toast = document.createElement('div');
            toast.className = 'toast';
            if(tipo === 'alerta') toast.classList.add('alerta');
            const icon = tipo === 'alerta'
                ? `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>`
                : `<svg width="20" height="20" viewBox="0 0 24 24" fill="white"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>`;
            toast.innerHTML = `${icon} ${texto}`;
            container.appendChild(toast);
            setTimeout(() => { toast.classList.add('saindo'); setTimeout(() => toast.remove(), 500); }, 3000);
        };

        window.abrirModalFinalizar = () => { document.getElementById('inputSenhaFinalizar').value = ''; document.getElementById('modalFinalizar').classList.add('visivel'); }
        window.fecharModalFinalizar = () => document.getElementById('modalFinalizar').classList.remove('visivel');
        window.confirmarFinalizar = function() {
            if (document.getElementById('inputSenhaFinalizar').value !== '4241') { alert('Senha incorreta!'); return; }
            window.fecharModalFinalizar();
            set(ref(db, 'status_atividade'), { comando: 'finalizar', data: new Date().toISOString() });
            window.mostrarNotificacao("Atividade encerrada!", 'alerta');
        };

        window.abrirModalLiberar = () => { document.getElementById('inputSenhaLiberar').value = ''; document.getElementById('modalLiberar').classList.add('visivel'); }
        window.fecharModalLiberar = () => document.getElementById('modalLiberar').classList.remove('visivel');
        window.confirmarLiberar = function() {
            if (document.getElementById('inputSenhaLiberar').value !== '4241') { alert('Senha incorreta!'); return; }
            window.fecharModalLiberar();
            set(ref(db, 'status_atividade'), { comando: 'liberado', data: new Date().toISOString() });
            window.mostrarNotificacao("Atividade liberada!", 'sucesso');
        };

        window.abrirModalReset = () => document.getElementById('modalReset').classList.add('visivel');
        window.fecharModalReset = () => document.getElementById('modalReset').classList.remove('visivel');
        window.prepararReset = function(tipo) {
            tipoResetPendente = tipo;
            window.fecharModalReset();
            document.getElementById('inputSenhaAction').value = '';
            document.getElementById('descSenhaAction').innerText = `Digite a senha para apagar: ${tipo.toUpperCase()}`;
            document.getElementById('modalSenhaAction').classList.add('visivel');
        }
        window.fecharModalSenhaAction = () => document.getElementById('modalSenhaAction').classList.remove('visivel');
        window.executarResetConfirmado = function() {
            if (document.getElementById('inputSenhaAction').value !== '4241') { alert('Senha incorreta!'); return; }
            if (tipoResetPendente === 'tudo') {
                remove(ref(db, 'alunos'));
                set(ref(db, 'status_atividade'), { comando: 'liberado' });
                alert("Reiniciado!");
            } else if (tipoResetPendente === 'hoje') {
                const hoje = new Date().toISOString().split('T')[0];
                todosRegistros.forEach(aluno => { if (aluno.data === hoje) remove(ref(db, 'alunos/' + aluno.id)); });
                alert("Registros de hoje apagados.");
            } else if (tipoResetPendente === 'mes') {
                const mesAtual = new Date().toISOString().slice(0, 7);
                todosRegistros.forEach(aluno => { if ((aluno.data || '').startsWith(mesAtual)) remove(ref(db, 'alunos/' + aluno.id)); });
                alert("Registros do m√™s apagados.");
            }
            window.fecharModalSenhaAction();
        }

        window.toggleDropdown = function(id) {
            const el = document.getElementById(id);
            const estaAberto = el.classList.contains('aberto');
            document.querySelectorAll('.dropdown-wrapper').forEach(d => d.classList.remove('aberto'));
            if(!estaAberto) el.classList.add('aberto');
        }
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.dropdown-wrapper')) document.querySelectorAll('.dropdown-wrapper').forEach(d => d.classList.remove('aberto'));
        });
        window.selecionarOpcao = function(tipo, valor, textoExibicao, elemento) {
            const wrapperId = tipo === 'ano' ? 'dropAno' : 'dropTurma';
            const wrapper = document.getElementById(wrapperId);
            wrapper.querySelectorAll('.opcao-item').forEach(i => i.classList.remove('selecionado'));
            elemento.classList.add('selecionado');
            if(tipo === 'ano') { filtroAnoAtual = valor; document.getElementById('textoAno').innerText = 'Ano: ' + textoExibicao; } 
            else { filtroTurmaAtual = valor; document.getElementById('textoTurma').innerText = 'Turma: ' + textoExibicao; }
            wrapper.classList.remove('aberto');
            window.renderizarRanking();
        }

        const listaEl = document.getElementById('listaRanking');
        const filtroData = document.getElementById('filtroData');
        filtroData.valueAsDate = new Date();
        filtroData.addEventListener('change', () => window.renderizarRanking());

        window.renderizarRanking = function() {
            const dataSel = filtroData.value;
            let filtrados = todosRegistros.filter(item => {
                const bateData = item.data === dataSel;
                const bateAno = filtroAnoAtual === 'todas' ? true : (item.serie || '').includes(filtroAnoAtual);
                const bateTurma = filtroTurmaAtual === 'todas' ? true : (item.serie || '').endsWith(" " + filtroTurmaAtual);
                return bateData && bateAno && bateTurma;
            });
            filtrados.sort((a, b) => (b.acertos || 0) - (a.acertos || 0));
            document.getElementById('totalAcessos').innerText = filtrados.length;
            let totalAcertos = filtrados.reduce((sum, item) => sum + (item.acertos || 0), 0);
            let media = filtrados.length ? (totalAcertos / filtrados.length).toFixed(1) : "0.0";
            document.getElementById('mediaAcertos').innerText = media;
            document.getElementById('melhorAluno').innerText = filtrados.length > 0 ? filtrados[0].nome : "-";
            listaEl.innerHTML = "";
            if (filtrados.length === 0) { listaEl.innerHTML = `<li style="padding:40px; text-align:center; color:var(--text-light)">Aguardando dados...</li>`; return; }
            filtrados.forEach((aluno, index) => {
                let rankClass = "", iconePosicao = index + 1;
                if (index === 0) { rankClass = "rank-1"; iconePosicao = "ü•á"; }
                else if (index === 1) { rankClass = "rank-2"; iconePosicao = "ü•à"; }
                else if (index === 2) { rankClass = "rank-3"; iconePosicao = "ü•â"; }
                listaEl.innerHTML += `
                    <li class="item-aluno ${rankClass}" data-aluno-id="${aluno.id}">
                        <div class="posicao">${iconePosicao}</div>
                        <div class="info-nome">${aluno.nome || '-'}</div>
                        <div><span class="info-serie">${aluno.serie || '-'}</span></div>
                        <div class="info-nota">${aluno.acertos || 0} pts</div>
                        <div class="info-erro">${aluno.erros || 0} err</div>
                        <div class="info-tempo">${aluno.hora || '--:--'}</div>
                    </li>
                `;
            });
        }

        window.addEventListener('DOMContentLoaded', () => {
            const overlay = document.getElementById('alunoModalOverlay');
            const modalNome = document.getElementById('alunoModalNome');
            const modalInfo = document.getElementById('alunoModalInfo');
            const btnFechar = document.getElementById('alunoModalFechar');
            const btnAcertos = document.getElementById('btnAcertosAluno');
            const btnErros = document.getElementById('btnErrosAluno');
            const btnAcertosNum = document.getElementById('btnAcertosAlunoNum');
            const btnErrosNum = document.getElementById('btnErrosAlunoNum');
            const listaModal = document.getElementById('listaModal');
            const listaTitulo = document.getElementById('listaModalTitulo');
            const listaFechar = document.getElementById('listaModalFechar');
            const listaQuestoesDiv = document.getElementById('listaQuestoes');
            let alunoSelecionado = null;

            function abrirModalAluno(aluno){
                alunoSelecionado = aluno;
                modalNome.textContent = aluno.nome || "Aluno(a)";
                const turma = aluno.turma ? `Turma: ${aluno.turma}` : "Turma: ‚Äî";
                const ano = aluno.ano ? `Ano: ${aluno.ano}` : "Ano: ‚Äî";
                modalInfo.textContent = `${turma} ‚Ä¢ ${ano}`;
                btnAcertosNum.textContent = aluno.acertos ?? 0;
                btnErrosNum.textContent = aluno.erros ?? 0;
                overlay.style.display = "flex";
                listaModal.style.display = "none";
                listaQuestoesDiv.innerHTML = "";
            }
            function fecharModalAluno(){ overlay.style.display = "none"; listaModal.style.display = "none"; alunoSelecionado = null; }
            btnFechar.addEventListener('click', fecharModalAluno);
            overlay.addEventListener('click', (e)=>{ if (e.target === overlay) fecharModalAluno(); });
            document.addEventListener('keydown', (e)=>{ if (e.key === "Escape" && overlay.style.display !== "none") fecharModalAluno(); });
            listaFechar.addEventListener('click', ()=>{ listaModal.style.display = "none"; listaQuestoesDiv.innerHTML = ""; });

            function getQuestaoPorId(qId){
                const [modo, idxStr] = String(qId || "").split("-");
                const idx = Number(idxStr);
                let q = null, titulo = null;
                if (modo === "intro") { q = (Array.isArray(questoesIntro) ? questoesIntro : [])[idx]; titulo = "Introdu√ß√£o"; } 
                else if (modo === "complementar") { q = (Array.isArray(questoesComp) ? questoesComp : [])[idx]; titulo = "Complementar"; }
                return { modo, idx, q, titulo };
            }

            // ‚úÖ L√ìGICA: ABRIR NOVA ABA COM ESTILOS
            listaQuestoesDiv.addEventListener('click', (e) => {
                const item = e.target.closest('.item-questao');
                if (item && item.dataset.id) {
                    abrirQuestaoNovaAba(item.dataset.id);
                }
            });

            function abrirQuestaoNovaAba(id) {
                const info = getQuestaoPorId(id);
                if (!info || !info.q) return;
                
                const win = window.open("", "_blank");
                if (!win) { alert("O pop-up foi bloqueado pelo navegador. Permita pop-ups para ver a quest√£o."); return; }
                
                const q = info.q;
                // Constr√≥i o HTML da nova aba, INJETANDO O CSS DA FRA√á√ÉO
                const htmlContent = `
                    <!DOCTYPE html>
                    <html lang="pt-BR">
                    <head>
                        <meta charset="UTF-8">
                        <title>Quest√£o ${info.titulo} - Q${info.idx + 1}</title>
                        <style>
                            body { font-family: -apple-system, sans-serif; padding: 40px; max-width: 800px; margin: 0 auto; background: #f5f5f7; color: #1d1d1f; }
                            .card { background: white; padding: 40px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
                            .header { margin-bottom: 20px; font-weight: 700; color: #86868b; text-transform: uppercase; font-size: 0.9rem; letter-spacing: 0.5px; }
                            .pergunta { font-size: 1.4rem; font-weight: 600; margin-bottom: 30px; line-height: 1.4; }
                            .img-wrapper { text-align: center; margin: 30px 0; }
                            img { max-width: 100%; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
                            .opcoes { display: grid; gap: 10px; }
                            .opcao { background: #f5f5f7; padding: 15px 20px; border-radius: 12px; font-size: 1.1rem; }
                            
                            /* --- CSS FRA√á√ÉO (COPIADO DO PAINEL PRINCIPAL) --- */
                            .fracao { display: inline-flex; flex-direction: column; vertical-align: middle; margin: 0 5px; text-align: center; font-size: 0.9em; }
                            .fracao > span { padding: 0 5px; }
                            .fracao > span:first-child { border-bottom: 2px solid currentColor; padding-bottom: 1px; }
                        </style>
                    </head>
                    <body>
                        <div class="card">
                            <div class="header">${info.titulo} ‚Ä¢ Quest√£o ${info.idx + 1}</div>
                            <div class="pergunta">${q.pergunta}</div>
                            ${q.img ? `<div class="img-wrapper"><img src="${q.img}"></div>` : ''}
                            <div class="opcoes">
                                ${(q.opcoes || []).map((op, i) => `<div class="opcao"><b>${String.fromCharCode(65+i)})</b> ${op}</div>`).join('')}
                            </div>
                        </div>
                    </body>
                    </html>
                `;
                
                win.document.write(htmlContent);
                win.document.close();
            }

            function renderListaQuestoes(tipo){
                if (!alunoSelecionado) return;
                const lista = (tipo === "acertos") ? (alunoSelecionado.listaAcertos || []) : (alunoSelecionado.listaErros || []);
                listaTitulo.textContent = (tipo === "acertos") ? "Quest√µes acertadas" : "Quest√µes erradas";
                listaModal.style.display = "block";
                if (!Array.isArray(lista) || lista.length === 0){ listaQuestoesDiv.innerHTML = `<div style="padding:10px;color:#6b7280;">Nenhuma quest√£o registrada.</div>`; return; }
                const ordenada = [...lista].sort((a,b)=>{
                    const [ma,ia]=String(a).split("-"); const [mb,ib]=String(b).split("-");
                    if (ma !== mb) return ma.localeCompare(mb); return (Number(ia)||0) - (Number(ib)||0);
                });
                const itens = ordenada.map((id)=>{
                    const info = getQuestaoPorId(id);
                    const label = info.titulo ? `${info.titulo} ‚Ä¢ Q${(info.idx ?? 0)+1}` : `Q${(info.idx ?? 0)+1}`;
                    const texto = info.q?.pergunta ? info.q.pergunta : "Quest√£o n√£o encontrada (banco mudou).";
                    const chip = `<span class="chip">${label}</span>`;
                    
                    // Adiciona data-id para o clique funcionar
                    return `
                    <div class="item-questao" data-id="${id}">
                        <div class="linha1">${chip}</div>
                        <div class="txt-curto">${texto}</div>
                    </div>`;
                }).join("");
                listaQuestoesDiv.innerHTML = itens;
            }
            btnAcertos.addEventListener('click', ()=>renderListaQuestoes("acertos"));
            btnErros.addEventListener('click', ()=>renderListaQuestoes("erros"));
            document.addEventListener('click', (e)=>{
                const li = e.target.closest('li.item-aluno');
                if (!li || !li.dataset || !li.dataset.alunoId) return;
                const id = li.dataset.alunoId;
                const aluno = (todosRegistros || []).find(x => x.id === id);
                if (aluno) abrirModalAluno(aluno);
            });
        });
    </script>

    <div id="alunoModalOverlay" class="aluno-modal-overlay" style="display:none;">
      <div id="alunoModal" class="aluno-modal" role="dialog" aria-modal="true" aria-label="Detalhes do aluno">
        <div class="aluno-modal-header">
          <div><div id="alunoModalNome" class="aluno-modal-nome"></div><div id="alunoModalInfo" class="aluno-modal-sub"></div></div>
          <button id="alunoModalFechar" class="aluno-modal-fechar" title="Fechar">‚úï</button>
        </div>
        <div class="aluno-modal-botoes">
          <button id="btnAcertosAluno" class="btn-placar btn-acerto" type="button"><span class="dot dot-verde"></span><span>Acertos</span><span id="btnAcertosAlunoNum" class="btn-num">0</span></button>
          <button id="btnErrosAluno" class="btn-placar btn-erro" type="button"><span class="dot dot-vermelho"></span><span>Erros</span><span id="btnErrosAlunoNum" class="btn-num">0</span></button>
        </div>
        <div class="aluno-modal-dica">Clique em <b>Acertos</b> ou <b>Erros</b> para ver a lista de quest√µes.</div>
      </div>
      <div id="listaModal" class="lista-modal" style="display:none;">
        <div class="lista-modal-header"><div id="listaModalTitulo" class="lista-modal-titulo"></div><button id="listaModalFechar" class="lista-modal-fechar" title="Fechar">‚úï</button></div>
        <div id="listaQuestoes" class="lista-questoes"></div>
      </div>
    </div>
</body>
</html>
